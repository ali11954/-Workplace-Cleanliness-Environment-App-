<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>التقارير البيانية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-light">

<div class="container my-5">

    <h2 class="text-center mb-4">التوزيع حسب المناطق</h2>

    <div class="card shadow rounded-4 mb-5">
        <div class="card-body">
            <canvas id="regionChart" height="100"></canvas>
        </div>
    </div>

    {% for region, sites in site_data.items() %}
    <h4 class="mt-5">{{ region }}</h4>
    <div class="card shadow rounded-4 mb-4">
        <div class="card-body">
            <canvas id="siteChart_{{ loop.index }}" height="100"></canvas>
        </div>
    </div>
    {% endfor %}

    <div class="d-flex justify-content-center mt-4 gap-3">
        <button class="btn btn-success" onclick="exportToExcel()">تصدير إلى Excel</button>
        <button class="btn btn-danger" onclick="exportToPDF()">تصدير إلى PDF</button>
    </div>

</div>

<script>
  // رسم التوزيع حسب المنطقة
  const ctxRegion = document.getElementById('regionChart').getContext('2d');
  new Chart(ctxRegion, {
    type: 'bar',
    data: {
      labels: {{ region_labels | tojson }},
      datasets: [{
        label: 'عدد التقييمات',
        data: {{ region_values | tojson }},
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // رسم التوزيع حسب المواقع في كل منطقة
  window.onload = function () {
    {% for region, sites in site_data.items() %}
    const ctxSite{{ loop.index }} = document.getElementById('siteChart_{{ loop.index }}').getContext('2d');
    new Chart(ctxSite{{ loop.index }}, {
      type: 'bar',
      data: {
        labels: {{ sites | map(attribute=0) | list | tojson }},
        datasets: [{
          label: 'عدد التقييمات',
          data: {{ sites | map(attribute=1) | list | tojson }},
          backgroundColor: 'rgba(153, 102, 255, 0.6)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
    {% endfor %}
  };

  // تصدير إلى Excel
  function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const ws_data = [['المنطقة', 'عدد التقييمات']];
    const labels = {{ region_labels | tojson }};
    const values = {{ region_values | tojson }};
    for (let i = 0; i < labels.length; i++) {
      ws_data.push([labels[i], values[i]]);
    }
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'التوزيع حسب المنطقة');
    XLSX.writeFile(wb, 'region_report.xlsx');
  }

  // تصدير إلى PDF
  async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait' });
    doc.setFont('helvetica');
    doc.text('التوزيع حسب المناطق', 105, 20, { align: 'center' });

    const canvas = document.getElementById('regionChart');
    const image = canvas.toDataURL("image/png", 1.0);
    doc.addImage(image, 'PNG', 15, 30, 180, 80);

    doc.save("region_report.pdf");
  }
</script>

</body>
</html>

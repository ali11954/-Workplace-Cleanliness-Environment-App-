{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h3 class="text-center mb-4 text-primary fw-bold">âœ¨ Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯ âœ¨</h3>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, msg in messages %}
                <div class="alert alert-{{ category }} shadow-sm rounded-3">{{ msg }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" id="evaluation-form" action="{{ url_for('evaluations') }}">
        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© -->
        <div class="card shadow-sm mb-3 border-0">
            <div class="card-body bg-light rounded-3">
                <label for="region" class="form-label fw-bold text-secondary">ğŸŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                <select name="region_id" id="region" class="form-select border-primary shadow-sm" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© --</option>
                    {% for r in regions %}
                        <option value="{{ r.id }}">{{ r.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
        <div class="card shadow-sm mb-3 border-0">
            <div class="card-body bg-light rounded-3">
                <label for="site" class="form-label fw-bold text-secondary">ğŸ“Œ Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                <select name="site_id" id="site" class="form-select border-success shadow-sm" required disabled>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ --</option>
                </select>
            </div>
        </div>

        <!-- Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± -->
        <div id="criteria-container" style="display:none;">
            <h5 class="fw-bold text-info mb-3">ğŸ“‘ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</h5>
            <div id="criteria-cards"></div>
        </div>

        <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© -->
        <div class="card shadow-sm mb-3 border-0">
            <div class="card-body bg-light rounded-3">
                <label for="notes" class="form-label fw-bold text-secondary">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</label>
                <textarea name="notes" id="notes" class="form-control border-warning shadow-sm" rows="3"></textarea>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-lg btn-primary shadow px-5 rounded-pill">
                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const regionSelect = document.getElementById('region');
    const siteSelect = document.getElementById('site');
    const criteriaContainer = document.getElementById('criteria-container');
    const criteriaCards = document.getElementById('criteria-cards');

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
    regionSelect.addEventListener('change', () => {
        const regionId = regionSelect.value;
        siteSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ --</option>';
        criteriaContainer.style.display = 'none';
        criteriaCards.innerHTML = '';
        if (regionId) {
            siteSelect.disabled = false;
            fetch(`/get_sites/${regionId}`)
                .then(res => res.json())
                .then(data => {
                    data.forEach(site => {
                        const option = document.createElement('option');
                        option.value = site.id;
                        option.textContent = site.name;
                        siteSelect.appendChild(option);
                    });
                });
        } else {
            siteSelect.disabled = true;
        }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† ÙˆÙ…Ø¹Ø§ÙŠÙŠØ±Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹
    siteSelect.addEventListener('change', () => {
        const siteId = siteSelect.value;
        criteriaCards.innerHTML = '';
        criteriaContainer.style.display = 'none';

        if (siteId) {
            fetch(`/get_site_criteria/${siteId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        criteriaContainer.style.display = 'block';

                        data.forEach(item => {
                            // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙƒØ§Ù†
                            const card = document.createElement('div');
                            card.className = "card shadow-sm mb-4 border-info";

                            const cardHeader = document.createElement('div');
                            cardHeader.className = "card-header bg-info text-white fw-bold";
                            cardHeader.innerHTML = `ğŸ“ ${item.place_name}`;
                            card.appendChild(cardHeader);

                            const cardBody = document.createElement('div');
                            cardBody.className = "card-body";

                            // Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø¯Ø§Ø®Ù„ Ø¬Ø¯ÙˆÙ„ Ù…Ù†Ø³Ù‚
                            const table = document.createElement('table');
                            table.className = "table table-bordered align-middle";
                            table.innerHTML = `
                                <thead class="table-light">
                                    <tr>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</th>
                                        <th>Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©</th>
                                        <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
                                        <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰</th>
                                        <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø§Ù„Ø¯Ø±Ø¬Ø©)</th>
                                        <th>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            `;

                            const tbody = table.querySelector('tbody');
                            item.criteria.forEach(criterion => {
                                const tr = document.createElement('tr');

                                const tdName = document.createElement('td');
                                tdName.textContent = criterion.name;

                                const tdAuthority = document.createElement('td');
                                tdAuthority.textContent = criterion.authority_name || '-';

                                const tdMin = document.createElement('td');
                                tdMin.textContent = criterion.min_score ?? '-';

                                const tdMax = document.createElement('td');
                                tdMax.textContent = criterion.max_score ?? '-';

                                const tdScore = document.createElement('td');
                                const inputScore = document.createElement('input');
                                inputScore.type = 'number';
                                inputScore.name = 'score[]';
                                inputScore.min = criterion.min_score || 0;
                                inputScore.max = criterion.max_score || 10;
                                inputScore.required = true;
                                inputScore.classList.add('form-control', 'border-primary', 'shadow-sm');

                                const inputId = document.createElement('input');
                                inputId.type = 'hidden';
                                inputId.name = 'criteria_ids[]';
                                inputId.value = criterion.id;

                                const inputAuthority = document.createElement('input');
                                inputAuthority.type = 'hidden';
                                inputAuthority.name = 'authority_ids[]';
                                inputAuthority.value = criterion.authority_id || '';

                                const inputPlace = document.createElement('input');
                                inputPlace.type = 'hidden';
                                inputPlace.name = 'place_ids[]';
                                inputPlace.value = item.place_id;

                                tdScore.appendChild(inputScore);
                                tdScore.appendChild(inputId);
                                tdScore.appendChild(inputAuthority);
                                tdScore.appendChild(inputPlace);

                                const tdNote = document.createElement('td');
                                const inputNote = document.createElement('input');
                                inputNote.type = 'text';
                                inputNote.name = 'criterion_notes[]';
                                inputNote.placeholder = 'Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)';
                                inputNote.classList.add('form-control', 'border-warning', 'shadow-sm');
                                tdNote.appendChild(inputNote);

                                tr.appendChild(tdName);
                                tr.appendChild(tdAuthority);
                                tr.appendChild(tdMin);
                                tr.appendChild(tdMax);
                                tr.appendChild(tdScore);
                                tr.appendChild(tdNote);

                                tbody.appendChild(tr);
                            });

                            cardBody.appendChild(table);
                            card.appendChild(cardBody);
                            criteriaCards.appendChild(card);
                        });
                    }
                });
        }
    });
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block styles %}
<style>
:root {
    --gold-primary: #D4AF37;
    --gold-secondary: #FFD700;
    --gold-light: #FFF8DC;
    --gold-dark: #B8860B;
    --gold-gradient: linear-gradient(135deg, #D4AF37 0%, #FFD700 50%, #FFF8DC 100%);
}

.reports-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.performance-comparison {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 2px solid rgba(212, 175, 55, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.comparison-card {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 15px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.comparison-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 5px;
    height: 100%;
    background: var(--gold-gradient);
}

.comparison-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 35px rgba(212, 175, 55, 0.2);
}

.best-performance {
    border-color: #28a745 !important;
}

.best-performance::before {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
}

.worst-performance {
    border-color: #dc3545 !important;
}

.worst-performance::before {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;
}

.site-card {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 15px;
    border: 2px solid rgba(212, 175, 55, 0.2);
    transition: all 0.3s ease;
}

.site-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.15);
}

.time-comparison {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 1.5rem;
    border: 2px solid rgba(212, 175, 55, 0.2);
}

.growth-indicator {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.9rem;
}

.growth-positive {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
}

.growth-negative {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
}

.growth-neutral {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
    border: 1px solid rgba(108, 117, 125, 0.3);
}

.performance-badge {
    position: absolute;
    top: 1rem;
    left: 1rem;
    z-index: 2;
}

.rank-1 {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #000;
}

.rank-2 {
    background: linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%);
    color: #000;
}

.rank-3 {
    background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
    color: #fff;
}

.site-stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    margin-top: 1rem;
}

.site-stat-item {
    text-align: center;
    padding: 0.5rem;
    background: rgba(212, 175, 55, 0.05);
    border-radius: 8px;
}

.site-stat-value {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--gold-primary);
}

.site-stat-label {
    font-size: 0.7rem;
    color: #6c757d;
}

.comparison-chart {
    height: 200px;
    background: linear-gradient(180deg, rgba(248, 249, 252, 0.8) 0%, rgba(255, 255, 255, 0.9) 100%);
    border-radius: 15px;
    padding: 1rem;
    position: relative;
}

.chart-bar {
    position: absolute;
    bottom: 0;
    width: 40px;
    background: var(--gold-gradient);
    border-radius: 8px 8px 0 0;
    transition: all 0.3s ease;
}

.chart-bar:hover {
    transform: scale(1.05);
}

.chart-label {
    position: absolute;
    bottom: -2rem;
    text-align: center;
    font-size: 0.8rem;
    font-weight: 600;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="reports-container py-4">
    <div class="container-fluid">
        <!-- رأس التقرير -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="report-header mb-2">
                            <i class="fas fa-chart-network me-3"></i>
                            التقارير والإحصائيات المتقدمة
                        </h1>
                        <p class="text-light mb-0">تحليل شامل ومقارنات زمنية وتقييم أداء</p>
                    </div>
                    <div class="export-buttons">
                        <div class="btn-group">
                            <button class="btn btn-gold me-2" onclick="generatePDF()">
                                <i class="fas fa-file-pdf me-2"></i>PDF
                            </button>
                            <button class="btn btn-outline-gold me-2" onclick="exportToExcel()">
                                <i class="fas fa-file-excel me-2"></i>Excel
                            </button>
                            <button class="btn btn-outline-light" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>طباعة
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- أفضل وأسوأ أداء -->
        {% if performance_comparison %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="performance-comparison p-4">
                    <h4 class="report-header mb-4">
                        <i class="fas fa-trophy me-2"></i>
                        أفضل وأسوأ أداء للمهندسين
                    </h4>

                    <div class="row">
                        <!-- أفضل تقييم -->
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="comparison-card best-performance p-3">
                                <span class="performance-badge badge rank-1">الأفضل</span>
                                <div class="text-center">
                                    <i class="fas fa-crown fa-2x text-warning mb-2"></i>
                                    <h5 class="text-success">{{ performance_comparison.best_rating.engineer.username }}</h5>
                                    <div class="rating-stars mb-2">
                                        {% for i in range(5) %}
                                        <i class="fas fa-star {% if i < performance_comparison.best_rating.avg_rating %}text-warning{% else %}text-light{% endif %}"></i>
                                        {% endfor %}
                                    </div>
                                    <h3 class="text-success mb-1">{{ performance_comparison.best_rating.avg_rating }}/5</h3>
                                    <small class="text-muted">أعلى تقييم</small>
                                </div>
                            </div>
                        </div>

                        <!-- أكثر طلبات مكتملة -->
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="comparison-card best-performance p-3">
                                <span class="performance-badge badge bg-primary">الأكثر</span>
                                <div class="text-center">
                                    <i class="fas fa-check-circle fa-2x text-primary mb-2"></i>
                                    <h5 class="text-primary">{{ performance_comparison.best_requests.engineer.username }}</h5>
                                    <h3 class="text-primary mb-1">{{ performance_comparison.best_requests.completed_requests }}</h3>
                                    <small class="text-muted">طلبات مكتملة</small>
                                    <div class="mt-2">
                                        <small class="text-muted">إجمالي: {{ performance_comparison.best_requests.total_requests }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- أفضل معدل إنجاز -->
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="comparison-card best-performance p-3">
                                <span class="performance-badge badge bg-info">الأسرع</span>
                                <div class="text-center">
                                    <i class="fas fa-bolt fa-2x text-info mb-2"></i>
                                    <h5 class="text-info">{{ performance_comparison.best_completion.engineer.username }}</h5>
                                    <h3 class="text-info mb-1">{{ performance_comparison.best_completion.completion_rate }}%</h3>
                                    <small class="text-muted">معدل إنجاز</small>
                                    <div class="mt-2">
                                        <small class="text-muted">وقت: {{ performance_comparison.best_completion.avg_completion_time }} يوم</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- أسوأ تقييم -->
                        {% if performance_comparison.worst_rating %}
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="comparison-card worst-performance p-3">
                                <span class="performance-badge badge bg-danger">للتحسين</span>
                                <div class="text-center">
                                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                                    <h5 class="text-danger">{{ performance_comparison.worst_rating.engineer.username }}</h5>
                                    <div class="rating-stars mb-2">
                                        {% for i in range(5) %}
                                        <i class="fas fa-star {% if i < performance_comparison.worst_rating.avg_rating %}text-warning{% else %}text-light{% endif %}"></i>
                                        {% endfor %}
                                    </div>
                                    <h3 class="text-danger mb-1">{{ performance_comparison.worst_rating.avg_rating }}/5</h3>
                                    <small class="text-muted">أقل تقييم</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- المقارنة الزمنية -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="time-comparison">
                    <h4 class="report-header mb-4">
                        <i class="fas fa-chart-line me-2"></i>
                        المقارنة الزمنية
                    </h4>

                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="comparison-chart" id="timeComparisonChart">
                                <!-- سيتم تعبئة الأعمدة بواسطة JavaScript -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row text-center">
                                <div class="col-6">
                                    <h3 class="text-muted">{{ time_comparison.previous_period_requests }}</h3>
                                    <p class="text-muted mb-0">{{ time_comparison.previous_period_label }}</p>
                                </div>
                                <div class="col-6">
                                    <h3 class="text-gold">{{ time_comparison.current_period_requests }}</h3>
                                    <p class="text-gold mb-0">{{ time_comparison.current_period_label }}</p>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <span class="growth-indicator {% if time_comparison.requests_growth > 0 %}growth-positive{% elif time_comparison.requests_growth < 0 %}growth-negative{% else %}growth-neutral{% endif %}">
                                    <i class="fas fa-arrow-{% if time_comparison.requests_growth > 0 %}up{% elif time_comparison.requests_growth < 0 %}down{% else %}right{% endif %} me-1"></i>
                                    {{ time_comparison.requests_growth }}%
                                </span>
                                <p class="text-muted mt-2 mb-0">نمو الطلبات</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- تقييم المواقع -->
        {% if site_stats %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="performance-comparison p-4">
                    <h4 class="report-header mb-4">
                        <i class="fas fa-building me-2"></i>
                        تقييم المواقع
                    </h4>

                    <div class="row">
                        {% for site in site_stats %}
                        <div class="col-xl-4 col-lg-6 mb-3">
                            <div class="site-card p-3">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="text-gold mb-1">{{ site.site.name }}</h5>
                                        <small class="text-muted">{{ site.site.location }}</small>
                                    </div>
                                    {% if loop.index <= 3 %}
                                    <span class="badge rank-{{ loop.index }}">{{ loop.index }}</span>
                                    {% endif %}
                                </div>

                                <div class="rating-stars text-center mb-3">
                                    {% for i in range(5) %}
                                    <i class="fas fa-star {% if i < site.avg_rating %}text-warning{% else %}text-light{% endif %}"></i>
                                    {% endfor %}
                                    <span class="ms-2 fw-bold text-muted">({{ site.avg_rating }})</span>
                                </div>

                                <div class="site-stats-grid">
                                    <div class="site-stat-item">
                                        <div class="site-stat-value">{{ site.total_requests }}</div>
                                        <div class="site-stat-label">إجمالي الطلبات</div>
                                    </div>
                                    <div class="site-stat-item">
                                        <div class="site-stat-value">{{ site.completion_rate }}%</div>
                                        <div class="site-stat-label">معدل الإنجاز</div>
                                    </div>
                                    <div class="site-stat-item">
                                        <div class="site-stat-value">{{ site.engineers_count }}</div>
                                        <div class="site-stat-label">المهندسين</div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            {{ site.priority_stats.high }} عاجلة
                                        </small>
                                        <small class="text-warning">
                                            <i class="fas fa-flag me-1"></i>
                                            {{ site.priority_stats.medium }} عالية
                                        </small>
                                        <small class="text-success">
                                            <i class="fas fa-check me-1"></i>
                                            {{ site.priority_stats.low }} عادية
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- أداء المهندسين التفصيلي -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="performance-comparison p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="report-header mb-0">
                            <i class="fas fa-users me-2"></i>
                            أداء المهندسين التفصيلي
                        </h4>
                        <div class="dropdown">
                            <button class="btn btn-outline-gold dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-sort me-2"></i>ترتيب حسب
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="sortEngineers('rating')">التقييم (الأعلى أولاً)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="sortEngineers('requests')">عدد الطلبات</a></li>
                                <li><a class="dropdown-item" href="#" onclick="sortEngineers('completion')">معدل الإنجاز</a></li>
                                <li><a class="dropdown-item" href="#" onclick="sortEngineers('time')">متوسط وقت التنفيذ</a></li>
                            </ul>
                        </div>
                    </div>

                    {% if engineer_stats %}
                    <div class="row">
                        {% for stat in engineer_stats %}
                        <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                            <div class="site-card p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-gold text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                                             style="width: 60px; height: 60px;">
                                            <span class="fw-bold fs-5">{{ stat.engineer.username[:1] }}</span>
                                        </div>
                                        <div>
                                            <h5 class="mb-1 fw-bold text-gold">{{ stat.engineer.username }}</h5>
                                            <small class="text-muted">{{ stat.engineer.email }}</small>
                                        </div>
                                    </div>
                                    <div class="performance-meter">
                                        <div class="meter-background" style="--value: {{ (stat.avg_rating / 5) * 100 }}%"></div>
                                        <div class="meter-inner">
                                            {{ stat.avg_rating if stat.avg_rating > 0 else '0.0' }}
                                        </div>
                                    </div>
                                </div>

                                <!-- النجوم -->
                                <div class="rating-stars text-center mb-3">
                                    {% for i in range(5) %}
                                    <i class="fas fa-star {% if i < stat.avg_rating %}text-warning{% else %}text-light{% endif %} fa-lg"></i>
                                    {% endfor %}
                                    <span class="ms-2 fw-bold text-muted">({{ stat.avg_rating if stat.avg_rating > 0 else 'لم يتم التقييم' }})</span>
                                </div>

                                <!-- إحصائيات سريعة -->
                                <div class="site-stats-grid">
                                    <div class="site-stat-item">
                                        <div class="site-stat-value">{{ stat.total_requests }}</div>
                                        <div class="site-stat-label">إجمالي الطلبات</div>
                                    </div>
                                    <div class="site-stat-item">
                                        <div class="site-stat-value">{{ stat.completed_requests }}</div>
                                        <div class="site-stat-label">مكتملة</div>
                                    </div>
                                    <div class="site-stat-item">
                                        <div class="site-stat-value">{{ stat.completion_rate }}%</div>
                                        <div class="site-stat-label">معدل الإنجاز</div>
                                    </div>
                                    <div class="site-stat-item">
                                        <div class="site-stat-value">{{ stat.avg_completion_time }}</div>
                                        <div class="site-stat-label">يوم/متوسط</div>
                                    </div>
                                </div>

                                <!-- شريط التقدم -->
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small>تقدم الإنجاز</small>
                                        <small class="fw-bold">{{ stat.completion_rate }}%</small>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success progress-bar-animated"
                                             style="width: {{ stat.completion_rate }}%;">
                                        </div>
                                    </div>
                                </div>

                                <!-- حالة المهندس -->
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge
                                            {% if stat.avg_rating >= 4 %}bg-success
                                            {% elif stat.avg_rating >= 3 %}bg-primary
                                            {% elif stat.avg_rating > 0 %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {% if stat.avg_rating >= 4 %}ممتاز
                                            {% elif stat.avg_rating >= 3 %}جيد جداً
                                            {% elif stat.avg_rating > 0 %}جيد
                                            {% else %}لم يتم التقييم{% endif %}
                                        </span>
                                        <small class="text-muted">
                                            {{ stat.rated_requests_count }} طلب تم تقييمه
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-users fa-4x mb-3 text-gold"></i>
                        <h5 class="text-gold">لا يوجد مهندسين مسجلين</h5>
                        <p>لم يتم تسجيل أي مهندسين في النظام بعد</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// دالة لعرض مخطط المقارنة الزمنية
function renderTimeComparisonChart() {
    const chart = document.getElementById('timeComparisonChart');
    const previous = {{ time_comparison.previous_period_requests }};
    const current = {{ time_comparison.current_period_requests }};

    // حساب أقصى قيمة للتطبيع
    const maxValue = Math.max(previous, current, 1);

    // إنشاء الأعمدة
    const previousHeight = (previous / maxValue) * 150;
    const currentHeight = (current / maxValue) * 150;

    chart.innerHTML = `
        <div class="chart-bar" style="left: 25%; height: ${previousHeight}px; background: #6c757d;"></div>
        <div class="chart-bar" style="left: 65%; height: ${currentHeight}px; background: var(--gold-gradient);"></div>
        <div class="chart-label" style="left: 25%">{{ time_comparison.previous_period_label }}</div>
        <div class="chart-label" style="left: 65%">{{ time_comparison.current_period_label }}</div>
    `;

    // إضافة تأثيرات للرسوم البيانية
    const bars = chart.querySelectorAll('.chart-bar');
    bars.forEach(bar => {
        const currentHeight = bar.style.height;
        bar.style.height = '0px';
        setTimeout(() => {
            bar.style.height = currentHeight;
        }, 500);
    });
}

// دالة لترتيب المهندسين
function sortEngineers(criteria) {
    const engineerCards = document.querySelectorAll('.site-card');
    const cardsArray = Array.from(engineerCards);

    cardsArray.sort((a, b) => {
        let aValue, bValue;

        switch(criteria) {
            case 'rating':
                aValue = parseFloat(a.querySelector('.meter-inner').textContent) || 0;
                bValue = parseFloat(b.querySelector('.meter-inner').textContent) || 0;
                return bValue - aValue;

            case 'requests':
                aValue = parseInt(a.querySelector('.site-stat-item:nth-child(1) .site-stat-value').textContent) || 0;
                bValue = parseInt(b.querySelector('.site-stat-item:nth-child(1) .site-stat-value').textContent) || 0;
                return bValue - aValue;

            case 'completion':
                aValue = parseFloat(a.querySelector('.site-stat-item:nth-child(3) .site-stat-value').textContent) || 0;
                bValue = parseFloat(b.querySelector('.site-stat-item:nth-child(3) .site-stat-value').textContent) || 0;
                return bValue - aValue;

            case 'time':
                aValue = parseFloat(a.querySelector('.site-stat-item:nth-child(4) .site-stat-value').textContent) || 0;
                bValue = parseFloat(b.querySelector('.site-stat-item:nth-child(4) .site-stat-value').textContent) || 0;
                return aValue - bValue;
        }
    });

    // إعادة ترتيب البطاقات في الواجهة
    const container = document.querySelector('.row');
    cardsArray.forEach(card => {
        container.appendChild(card.parentElement);
    });

    showNotification(`تم ترتيب المهندسين حسب: ${getCriteriaName(criteria)}`, 'success');
}

function getCriteriaName(criteria) {
    const names = {
        'rating': 'التقييم',
        'requests': 'عدد الطلبات',
        'completion': 'معدل الإنجاز',
        'time': 'متوسط وقت التنفيذ'
    };
    return names[criteria] || criteria;
}

// دالة لعرض الإشعارات
function showNotification(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';

    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; left: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// دالة لتصدير PDF
function generatePDF() {
    showNotification('جاري إنشاء التقرير PDF...', 'info');
    setTimeout(() => {
        showNotification('تم إنشاء التقرير PDF بنجاح', 'success');
    }, 2000);
}

// دالة لتصدير Excel
function exportToExcel() {
    showNotification('جاري تصدير البيانات إلى Excel...', 'info');
    setTimeout(() => {
        showNotification('تم التصدير إلى Excel بنجاح', 'success');
    }, 2000);
}

// تفعيل التأثيرات عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    renderTimeComparisonChart();

    // إضافة تأثيرات للبطاقات
    const cards = document.querySelectorAll('.comparison-card, .site-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-card');
    });

    // تأثيرات أشرطة التقدم
    const progressBars = document.querySelectorAll('.progress-bar-animated');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 500);
    });
});
</script>
{% endblock %}
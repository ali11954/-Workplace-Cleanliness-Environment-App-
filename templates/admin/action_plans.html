{% extends "base.html" %}

{% block title %}Ø®Ø·Ø· Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center text-primary fw-bold">Ø®Ø·Ø· Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>

    {% if action_plans %}

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø£ÙƒØ«Ø± 5 Ù…Ø¹Ø§ÙŠÙŠØ± ØªÙƒØ±Ø§Ø±Ù‹Ø§ -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title text-success fw-bold">ğŸ“Š Ø£ÙƒØ«Ø± 5 Ù…Ø¹Ø§ÙŠÙŠØ± ØªÙƒØ±Ø§Ø±Ù‹Ø§</h5>
            <ul class="list-group list-group-flush">
                {% for criterion in top_criteria %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ criterion.name }}
                    <span class="badge bg-success rounded-pill">{{ criterion.count }}</span>
                </li>
                {% endfor %}
            </ul>
            <canvas id="criteriaChart" class="mt-3"></canvas>
        </div>
    </div>

    <!-- ÙÙ„ØªØ±Ø© ÙˆØ¨Ø­Ø« -->
    <div class="row mb-3">
        <div class="col-md-4 mb-2">
            <input type="text" id="searchInput" class="form-control" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹...">
        </div>
        <div class="col-md-3 mb-2">
            <select id="filterStatus" class="form-select">
                <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="Ù…ÙØªÙˆØ­Ø©">Ù…ÙØªÙˆØ­Ø©</option>
                <option value="Ù…ØºÙ„Ù‚Ø©">Ù…ØºÙ„Ù‚Ø©</option>
            </select>
        </div>
        <div class="col-md-5 text-end mb-2">
            <button class="btn btn-outline-success" onclick="exportTableToExcel('actionPlanTable', 'ActionPlans')">ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn btn-outline-primary" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© PDF</button>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped" id="actionPlanTable">
            <thead class="table-success">
                <tr>
                    <th>Ù…</th>
                    <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                    <th>Ø®Ø·ÙˆØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</th>
                    <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                    <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                    <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                    <th>Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</th>
                    <th>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±</th>
                    <th>Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø¹ÙŠØ§Ø±</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th>
                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th>
                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th>
                    <th>ØªØ­Ø³Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                    <th>Ø¥ØºÙ„Ø§Ù‚</th>
                </tr>
            </thead>
            <tbody>
                {% for plan in action_plans %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td class="text-start">{{ plan.note or '-' }}</td>
                    <td class="text-start">{{ plan.action_plans[0].action_plan if plan.action_plans else '-' }}</td>
                    <td>{{ plan.evaluation.region.name if plan.evaluation and plan.evaluation.region else '-' }}</td>
                    <td>{{ plan.evaluation.site.name if plan.evaluation and plan.evaluation.site else '-' }}</td>
                    <td>{{ plan.place.name if plan.place else '-' }}</td>
                    <td>{{ plan.criterion.name if plan.criterion else '-' }}</td>
                    <td>
                        {% if plan.criterion %}
                            {{ criterion_counts.get((
                                plan.criterion.name,
                                plan.place.name if plan.place else '-',
                                plan.evaluation.site.name if plan.evaluation and plan.evaluation.site else '-',
                                plan.evaluation.region.name if plan.evaluation and plan.evaluation.region else '-'
                            ), 0) }}
                        {% else %}
                            0
                        {% endif %}
                    </td>
                    <td>{{ plan.score if plan.score is not none else '-' }}</td>
                    <td>{{ plan.timestamp.strftime('%Y-%m-%d') if plan.timestamp else '-' }}</td>
                    <td class="{{ 'text-success fw-bold' if plan.action_plans and plan.action_plans[0].closed else 'text-danger fw-bold' }}">
                        {{ 'Ù…ØºÙ„Ù‚Ø©' if plan.action_plans and plan.action_plans[0].closed else 'Ù…ÙØªÙˆØ­Ø©' }}
                    </td>
                    <td>{{ plan.action_plans[0].closed_date.strftime('%Y-%m-%d') if plan.action_plans and plan.action_plans[0].closed_date else '-' }}</td>
                    <td>
                        {% if plan.action_plans and plan.action_plans[0].closed_date and plan.timestamp %}
                            {{ (plan.action_plans[0].closed_date.date() - plan.timestamp.date()).days }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ plan.action_plans[0].closing_note if plan.action_plans else '-' }}</td>
                    <td>{{ plan.action_plans[0].improvement_score if plan.action_plans and plan.action_plans[0].improvement_score is not none else '-' }}</td>
                    <td>
                        {% if not plan.action_plans or not plan.action_plans[0].closed %}
                            <form action="{{ url_for('close_note', note_id=plan.id) }}" method="POST" class="d-flex flex-column">
                                <input type="date" name="closed_date" class="form-control mb-1" required>
                                <input type="text" name="closing_note" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚" class="form-control mb-1">
                                <input type="number" name="improvement_score" placeholder="ØªØ­Ø³Ù† %" class="form-control mb-1" min="0" max="100" required>
                                <button type="submit" class="btn btn-success btn-sm">Ø¥ØºÙ„Ø§Ù‚</button>
                            </form>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <p class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>
    {% endif %}
</div>
{% endblock %}

{% block styles %}
<style>
.table-responsive { overflow-x: auto; }
#actionPlanTable {
    width: 100%;
    min-width: 1200px;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.9rem;
}
#actionPlanTable th, #actionPlanTable td { vertical-align: middle; text-align: center; padding: 8px 10px; }
#actionPlanTable thead th {
    background: linear-gradient(135deg, #198754, #20c997);
    color: #fff; font-weight: bold;
    position: sticky; top: 0; z-index: 2;
}
#actionPlanTable tbody tr { transition: background 0.3s, transform 0.2s; }
#actionPlanTable tbody tr:nth-child(even) { background-color: rgba(0,0,0,0.03); }
#actionPlanTable tbody tr:hover { background-color: rgba(25, 135, 84, 0.08); transform: scale(1.01); }
#actionPlanTable td { border-bottom: 1px solid rgba(0,0,0,0.05); }

form input, form button { font-size: 0.8rem; }
form input { height: 30px; }
form button { height: 30px; padding: 2px 8px; }

#searchInput, #filterStatus { border-radius: 0.3rem; padding: 5px 10px; }
.btn-outline-success, .btn-outline-primary { border-radius: 0.3rem; font-size: 0.85rem; padding: 5px 12px; transition: transform 0.2s; }
.btn-outline-success:hover, .btn-outline-primary:hover { transform: scale(1.05); }

@media (max-width: 1200px) { #actionPlanTable { min-width: 1200px; } }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    document.getElementById('filterStatus').addEventListener('change', function() {
        let status = this.value;
        let rows = document.querySelectorAll('#actionPlanTable tbody tr');
        rows.forEach(row => {
            let cell = row.cells[10];
            row.style.display = (status === "" || (cell && cell.innerText === status)) ? '' : 'none';
        });
    });

    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
    document.getElementById('searchInput').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let rows = document.querySelectorAll('#actionPlanTable tbody tr');
        rows.forEach(row => {
            row.style.display = Array.from(row.cells).some(td => td.innerText.toLowerCase().includes(filter)) ? '' : 'none';
        });
    });

    // ØªØµØ¯ÙŠØ± Excel
    function exportTableToExcel(tableID, filename = '') {
        let table = document.getElementById(tableID);
        let wb = XLSX.utils.table_to_book(table, {sheet:"Sheet 1"});
        XLSX.writeFile(wb, filename ? filename + ".xlsx" : "ActionPlans.xlsx");
    }

    // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ù‹Ø§
    const labels = {{ top_criteria | map(attribute='name') | list | tojson }};
    const counts = {{ top_criteria | map(attribute='count') | list | tojson }};
    const infos  = {{ top_criteria | map(attribute='info') | default([]) | list | tojson }};

    new Chart(document.getElementById('criteriaChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª',
                data: counts,
                backgroundColor: ['#20c997','#0d6efd','#ffc107','#dc3545','#198754'],
                borderRadius: 5
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Ø§Ù„ØªÙƒØ±Ø§Ø±: ${context.parsed.y} | ${infos[context.dataIndex] || '-'}`;
                        }
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª' } },
                x: { title: { display: true, text: 'Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±' } }
            }
        }
    });
</script>
{% endblock %}
